name: Update LeetCode Ranking

on:
  push:
    branches: [ master, main ]
    paths:
      - '*/0-easy/*.ts'
      - '*/1-medium/*.ts'
      - '*/2-hard/*.ts'
      - '!README.md'
      - '!*/index.ts'

jobs:
  update-ranking:
    runs-on: ubuntu-latest
    
    # Evita execução em commits automáticos da própria action
    if: "!contains(github.event.head_commit.message, '[auto-update]')"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Make scripts executable
      run: |
        chmod +x ./3-scripts/*.sh

    - name: Update ranking
      run: |
        ./3-scripts/update-ranking.sh

    - name: Check for changes in README
      id: verify-changed-files
      run: |
        if git diff --quiet README.md; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "❌ Nenhuma alteração no ranking detectada"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "✅ Ranking atualizado - alterações detectadas no README.md"
          git diff --name-only
        fi

    - name: Commit and push ranking update
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "LeetCode Ranking Bot"
        git add README.md
        git commit -m "🤖 [auto-update] Update LeetCode ranking

        - Updated statistics for all contributors
        - Updated solved problems list
        
        Auto-generated by GitHub Actions"
        git push

    - name: Action summary
      run: |
        echo "## 📊 LeetCode Ranking Update" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          echo "✅ **Ranking atualizado com sucesso!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "O README.md foi atualizado com as estatísticas mais recentes dos problemas resolvidos." >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ **Nenhuma atualização necessária**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "O ranking já está atualizado com base nos problemas atuais." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** Push para branch master" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY