name: Update LeetCode Ranking

on:
  push:
    branches: [ master, main ]
    paths:
      - '*/0-easy/*.ts'
      - '*/1-medium/*.ts'
      - '*/2-hard/*.ts'
      - '!README.md'
      - '!*/index.ts'
  
  # ✅ ADICIONE ESTE TRIGGER MANUAL
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual execution'
        required: false
        default: 'Manual ranking update'
        type: string

permissions:
  contents: write
  actions: read

jobs:
  update-ranking:
    runs-on: ubuntu-latest
    
    if: "!contains(github.event.head_commit.message, '[auto-update]')"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # ✅ ADICIONE STEP PARA MOSTRAR CONTEXTO DA EXECUÇÃO
    - name: Show execution context
      run: |
        echo "## 🚀 Execution Context" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Commit:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.event.head_commit.author.name }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Make scripts executable
      run: |
        chmod +x ./3-scripts/*.sh

    - name: Update ranking
      run: |
        bash ./3-scripts/update-ranking.sh

    - name: Check for changes in README
      id: verify-changed-files
      run: |
        if git diff --quiet README.md; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "❌ Nenhuma alteração no ranking detectada"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "✅ Ranking atualizado - alterações detectadas no README.md"
          git diff --name-only
        fi

    - name: Commit and push ranking update
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "LeetCode Ranking Bot"
        git add README.md
        
        # ✅ COMMIT MESSAGE DIFERENTE PARA EXECUÇÃO MANUAL
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          git commit -m "🤖 [auto-update] Manual ranking update

        Reason: ${{ github.event.inputs.reason }}
        Triggered by: ${{ github.actor }}
        
        Auto-generated by GitHub Actions"
        else
          git commit -m "🤖 [auto-update] Update LeetCode ranking

        - Updated statistics for all contributors
        - Updated solved problems list
        
        Auto-generated by GitHub Actions"
        fi
        git push

    - name: Action summary
      run: |
        echo "## 📊 LeetCode Ranking Update" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          echo "✅ **Ranking atualizado com sucesso!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ **Nenhuma atualização necessária**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Execution type:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY